name: Test Algorithm

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test algorithm template
      working-directory: ./template
      run: |
        python test_algorithm.py
    
    - name: Validate specification
      working-directory: ./template
      run: |
        python -c "import yaml; yaml.safe_load(open('spec.yaml'))"
        echo "✓ Specification file is valid YAML"
    
    - name: Test hello world example
      working-directory: ./examples/hello_world
      run: |
        python -c "
        from algorithm import HelloWorldAlgorithm
        algo = HelloWorldAlgorithm()
        print(f'✓ Hello World algorithm: {algo.get_name()}')
        circuit = algo.build_circuit({'epsilon': 0.01, 'payoff': 'max'})
        print(f'✓ Circuit built with {circuit.num_qubits()} qubits')
        "
    
    - name: Submit to Qernel API (main branch only)
      if: github.ref == 'refs/heads/main'
      env:
        QERNEL_API_KEY: ${{ secrets.QERNEL_API_KEY }}
      working-directory: ./template
      run: |
        python -c "
        try:
            from qernel import QernelClient
            client = QernelClient()
            result = client.run_algorithm('algorithm_template.py', 'spec.yaml')
            print(f'✓ Submission successful: {result[\"run_id\"]}')
        except Exception as e:
            print(f'⚠ API submission failed (this is expected without API key): {e}')
            print('This is normal if QERNEL_API_KEY is not configured')
        "
