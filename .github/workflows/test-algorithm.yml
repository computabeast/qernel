name: Test Algorithm

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test algorithm
      run: |
        python test/test_algorithm.py
    
    - name: Validate specification
      run: |
        python -c "import yaml; yaml.safe_load(open('spec.yaml'))"
        echo "✓ Specification file is valid YAML"
    
    - name: Test qernel package
      run: |
        python -c "
        from qernel import Algorithm, QernelClient
        print('✓ Qernel package imports successfully')
        "
    
    - name: Test visualization (import only)
      run: |
        python -c "
        from qernel.vis import AlgorithmVisualizer
        print('✓ Visualization package imports successfully')
        "
    
    - name: Submit to Qernel API (main branch only)
      if: github.ref == 'refs/heads/main'
      env:
        QERNEL_API_KEY: ${{ secrets.QERNEL_API_KEY }}
      run: |
        python -c "
        try:
            from qernel import QernelClient, PluginLoader
            client = QernelClient()
            
            # Discover and submit all algorithms
            algorithms = PluginLoader.discover_algorithms()
            for algorithm_name, spec_file in algorithms.items():
                algorithm_file = spec_file.replace('spec.yaml', f'{algorithm_name}.py')
                result = client.run_algorithm(algorithm_file, spec_file)
                print(f'✓ Submitted {algorithm_name}: {result[\"run_id\"]}')
                
        except Exception as e:
            print(f'⚠ API submission failed (this is expected without API key): {e}')
            print('This is normal if QERNEL_API_KEY is not configured')
        "
